<!DOCTYPE html>
<html>
  <head>
    <title>OFraMP</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="static/css/style.css" />
    <!--[if IE]><script type="text/javascript" src="static/js/lib/excanvas.js"></script><![endif]-->
    <script type="text/javascript" src="static/js/compatibility/es5.js"></script>
    <script type="text/javascript" src="static/js/compatibility/json3.min.js"></script>
    <script type="text/javascript" src="static/js/compatibility/console.js"></script>
    <script type="text/javascript" src="static/js/compatibility/Element.js"></script>
    <script type="text/javascript" src="static/js/compatibility/Window.js"></script>

    <script type="text/javascript" src="static/js/lib/BrowserDetect.js"></script>
    <script type="text/javascript" src="static/js/lib/dat.gui.js"></script>
    <script type="text/javascript" src="static/js/lib/URLParams.js"></script>

    <script type="text/javascript" src="static/js/extensions/extensions.js"></script>
    <script type="text/javascript" src="static/js/extensions/Array.js"></script>
    <script type="text/javascript" src="static/js/extensions/CanvasRenderingContext2D.js"></script>
    <script type="text/javascript" src="static/js/extensions/Date.js"></script>
    <script type="text/javascript" src="static/js/extensions/DOM.js"></script>
    <script type="text/javascript" src="static/js/extensions/MouseEvent.js"></script>
    <script type="text/javascript" src="static/js/extensions/Number.js"></script>
    <script type="text/javascript" src="static/js/extensions/Object.js"></script>
    <script type="text/javascript" src="static/js/extensions/String.js"></script>

    <script type="text/javascript" src="static/js/Tree/Tree.js"></script>
    <script type="text/javascript" src="static/js/Tree/TreeVis.js"></script>

    <script type="text/javascript" src="static/js/Cache/DummyCache.js"></script>
    <script type="text/javascript" src="static/js/Cache/Cache.js"></script>

    <script type="text/javascript" src="static/js/OFraMP/Atom.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/AtomList.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/Bond.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/BondList.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/Demo.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/Molecule.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/MoleculeViewer.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/OFraMP.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/SelectionArea.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/settings.js"></script>

    <script type="text/javascript" src="static/js/OFraMP/Behavior.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/behaviors/NaiveBehavior.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/behaviors/SmartBehavior.js"></script>
    <script>
      window.onload = function() {
        var OAPoC_URL = document.URL.match(/vps955\.directvps\.nl/) ? "http://vps955.directvps.nl/OAPoC/generate/" : "http://127.0.0.1:8000/generate/";
        var OAPoC_LOAD_URL = document.URL.match(/vps955\.directvps\.nl/) ? "http://vps955.directvps.nl/OAPoC/loadATB/" : "http://127.0.0.1:8000/loadATB/";
        var OMFraF_URL = document.URL.match(/vps955\.directvps\.nl/) ? "http://vps955.directvps.nl/OMFraF/load/" : "http://127.0.0.1:8001/load/";
        var OMFraF_GENERATE_URL = document.URL.match(/vps955\.directvps\.nl/) ? "http://vps955.directvps.nl/OMFraF/generate/" : "http://127.0.0.1:8001/generate/";

        var oframp = new OFraMP(NaiveBehavior, "oframp", {
          oapoc : {
            url : OAPoC_URL,
            loadUrl : OAPoC_LOAD_URL
          },
          omfraf: {
            url: OMFraF_URL,
            generateUrl: OMFraF_GENERATE_URL
          }
        });

        window.onresize = function() {
          oframp.setMVSize(document.documentElement.clientWidth, document.documentElement.clientHeight);
        };

        // ONLY for debug purposes, TODO : remove
        doframp = oframp;

        var zi = document.getElementById("zoomin");
        zi.onclick = function() {
          oframp.zoom(1.1);
        };
        var zo = document.getElementById("zoomout");
        zo.onclick = function() {
          oframp.zoom(.9);
        };
        var zp = document.getElementById("zoom");
        zp.onclick = function(e, x, y, z) {
          switch(zp.value) {
            case 'min':
              oframp.minimize();
              break;

            case 'max':
              oframp.maximize();
              break;

            case 'avg':
              oframp.idealize();
              break;

            case 'fit':
              oframp.bestFit();
              break;
          }
          zp.value = 'pre';
        };

        var rp = document.getElementById("reset");
        rp.onclick = function() {
          oframp.resetPositions();
        };

        var dl = document.getElementById("download");
        dl.onclick = function() {
          var data = oframp.getMVDataURI('image/png');
          this.href = data.replace(/^data:image\/[^;]/, 'data:application/octet-stream');
          var date = $ext.date.format(new Date(), "%Y%m%d%H%M%S");
          this.download = "OFraMP-" + date + ".png";
        };

        var nm = document.getElementById("new");
        $ext.dom.onMouseClick(nm, newMolecule, $ext.mouse.LEFT);
        function newMolecule() {
          oframp.showInsertMoleculePopup();
        }

        var of = document.getElementById("open");
        $ext.dom.onMouseClick(of, openFile, $ext.mouse.LEFT);
        function openFile() {
          oframp.showInsertMoleculePopup();
          var lb = document.getElementById("load_oss");
          lb.click();
        }

        var sv = document.getElementById("save");
        $ext.dom.onMouseClick(sv, saveMolecule, $ext.mouse.LEFT);
        function saveMolecule() {
          var data = oframp.getDataURI();
          sv.href = data;
          var date = $ext.date.format(new Date(), "%Y%m%d%H%M%S");
          sv.type = "application/json";
          sv.download = "OFraMP-" + date + ".oss";
        }

        var sb = document.getElementById("share");
        $ext.dom.onMouseClick(sb, function(e) {
          shareLink();
          e.preventDefault();
        }, $ext.mouse.LEFT);
        function shareLink() {
          var data = oframp.getDataURI();
          var oss = data.replace(/^data:application\/octet-stream:base64,/, '');
          sb.href = "?oss=";

          var title = "URL to the current state, copy to share (Ctrl+C)";
          var content = document.createElement('div');

          var lta = document.createElement('textarea');
          lta.appendChild(document.createTextNode(sb.href + encodeURIComponent(oss)));
          sb.href = "#";
          content.appendChild(lta);
          lta.onfocus = function() {
            lta.select();

            // Work around Chrome's little problem
            lta.onmouseup = function() {
              // Prevent further mouseup intervention
              lta.onmouseup = null;
              return false;
            };
          };

          var cb = document.createElement('button');
          cb.className = "border_box controls";
          cb.appendChild(document.createTextNode("Cancel"));
          cb.onclick = function() {
            oframp.hidePopup();
          };
          content.appendChild(cb);

          oframp.showPopup(title, content);
          // Weird bug in Chrome messes up document height upon focus call..
          // lta.focus();
        }

        var ub = document.getElementById("undo");
        $ext.dom.onMouseClick(ub, function() {
          undo();
        });
        function undo() {
          if(!oframp.checkpoints) {
            return;
          }

          if(oframp.activeCheckpoint > 0) {
            oframp.previousCheckpoint();
          }
        }

        var rb = document.getElementById("redo");
        $ext.dom.onMouseClick(rb, function() {
          redo();
        });
        function redo() {
          if(!oframp.checkpoints) {
            return;
          }

          if(oframp.activeCheckpoint < oframp.checkpoints.length - 1) {
            oframp.nextCheckpoint();
          }
        }

        var op = document.getElementById("opti");
        if ($ext.onBrokenIE()) {
          op.remove();
        } else {
          $ext.dom.onMouseClick(op, function() {
            oframp.settingsUI.toggle();
          }, $ext.mouse.LEFT);
        }

        $ext.dom.addEventListener(oframp.container, 'historychanged', function() {
          if(oframp.activeCheckpoint === 0) {
            ub.disabled = "disabled";
          } else {
            ub.disabled = "";
          }

          if(oframp.activeCheckpoint === oframp.checkpoints.length - 1) {
            rb.disabled = "disabled";
          } else {
            rb.disabled = "";
          }
        });

        var controlsInitialized = false;
        var header = document.getElementById("header");
        var controls = document.getElementById("controls");
        var extraControls = document.getElementById("extra_controls");
        var fragmentControls = document.getElementById("fragment_controls");
        var toggle = document.getElementById("extra_controls_toggle");
        var extraControlsVisible = false;
        function initControls() {
          controls.style.display = "inline-block";
          extraControls.style.display = "inline-block";
          fragmentControls.style.display = "block";

          $ext.dom.onMouseClick(toggle, function() {
            if(extraControlsVisible) {
              header.style.height = "30px";
              toggle.style.backgroundImage = "url('static/img/close.png')";
              extraControlsVisible = false;
            } else {
              header.style.height = "70px";
              toggle.style.backgroundImage = "url('static/img/open.png')";
              extraControlsVisible = true;
            }
          }, $ext.mouse.LEFT);

          $ext.dom.addEventListener(window, 'keydown', function(evt) {
            if(!evt.altKey) {
              return;
            }

            var keyCode = evt.keyCode || evt.charCode;
            if(keyCode > 26) {
              keyCode -= 64;
            }
            if(keyCode === 26) {
              if(evt.shiftKey) {
                redo();
              } else {
                undo();
              }
            } else if(keyCode === 25) {
              redo();
            } else if(keyCode === 14) {
              newMolecule();
            } else if(keyCode === 15) {
              openFile();
            } else if(keyCode === 19) {
              saveMolecule();
              sv.click();
            } else if(keyCode === 12) {
              shareLink();
            }
          });

          controlsInitialized = true;
        }

        $ext.dom.addEventListener(oframp.container, 'moleculeentered', function() {
          if (controlsInitialized) {
            controls.style.display = "none";
            extraControls.style.display = "none";
            fragmentControls.style.display = "none";
          }
        });

        $ext.dom.addEventListener(oframp.container, 'moleculedisplayed', function() {
          if (!controlsInitialized) {
            initControls();
          } else {
            controls.style.display = "inline-block";
            extraControls.style.display = "inline-block";
            fragmentControls.style.display = "block";
          }
        });

        if(URLParams) {
          if(URLParams.mds) {
            oframp.submitMDS(URLParams.mds);
          } else if(URLParams.atb_id) {
            oframp.submitMDS(URLParams.atb_id);
          } else if(URLParams.oss) {
            oframp.loadOSS(URLParams.oss);
          }
        }
      };
    </script>
  </head>

  <body>
    <div id="header">
      <div id="logo">
        <span id="logo_o">O</span><span id="logo_fra">Fra</span><span id="logo_m">M</span><span id="logo_p">P</span>
      </div>

      <div id="controls">
        <div class="bgroup">
          <button id="new" class="border_box" title="Submit another molecule (Alt+N)">
            New molecule
          </button>
          <button id="open" class="border_box" title="Open a saved molecule (Alt+O)">
            Open
          </button>
          <a id="save" class="border_box" href="#" title="Save the current state (Alt+S)">
            Save
          </a>
          <a id="share" class="border_box" href="#" title="Share a link to the current state (Alt+L)">
            Share
          </a>
        </div>

        <div class="bgroup">
          <button id="undo" class="border_box" title="Undo last action (Alt+Z)">
            Undo
          </button>
          <button id="redo" class="border_box" title="Redo last action (Alt+Y / Alt+Shift+Z)">
            Redo
          </button>
        </div>

        <div class="bgroup">
          <button id="extra_controls_toggle" class="border_box" title="Show/Hide advanced controls">
            &nbsp;
          </button>
        </div>
      </div>

      <div id="extra_controls">
        <div class="bgroup">
          <button id="zoomin" class="border_box" title="Zoom in">
            Zoom +
          </button>
          <button id="zoomout" class="border_box" title="Zoom out">
            Zoom -
          </button>
          <select id="zoom" class="border_box" title="Zoom to a predefined level">
            <option value="pre" disabled="disabled" selected="selected">Predefined</option>
            <option value="min">Minimal</option>
            <option value="avg">Ideal</option>
            <option value="max">Maximal</option>
            <option value="fit">Best fit</option>
          </select>
        </div>

        <div class="bgroup">
          <button id="reset" class="border_box" title="Reset the atom positions">
            Reset positions
          </button>
        </div>

        <div class="bgroup">
          <a id="download" class="border_box" href="" title="Download the molecule as an image">
            Download
          </a>
        </div>

        <div class="bgroup">
          <button id="opti" class="border_box" title="Settings">
            Settings
          </button>
        </div>
      </div>
    </div>

    <div id="fragment_controls">
      <button id="find_fragments" class="border_box" title="Find matching fragments">
        Find fragments
      </button>
    </div>

    <div id="copyright">
      &copy; 2013-2014 jimivdw | CWI
    </div>

    <div id="oframp"></div>
  </body>
</html>
