<!DOCTYPE html>
<html>
  <head>
    <title>OFraMP</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="static/css/style.css" />
    <!--[if IE]><script type="text/javascript" src="static/js/lib/excanvas.js"></script><![endif]-->
    <script type="text/javascript" src="static/js/compatibility/es5.js"></script>
    <script type="text/javascript" src="static/js/compatibility/json3.min.js"></script>
    <script type="text/javascript" src="static/js/compatibility/console.js"></script>
    <script type="text/javascript" src="static/js/compatibility/Element.js"></script>
    <script type="text/javascript" src="static/js/compatibility/Window.js"></script>

    <script type="text/javascript" src="static/js/lib/BrowserDetect.js"></script>
    <script type="text/javascript" src="static/js/lib/dat.gui.js"></script>

    <script type="text/javascript" src="static/js/extensions/extensions.js"></script>
    <script type="text/javascript" src="static/js/extensions/Array.js"></script>
    <script type="text/javascript" src="static/js/extensions/CanvasRenderingContext2D.js"></script>
    <script type="text/javascript" src="static/js/extensions/Date.js"></script>
    <script type="text/javascript" src="static/js/extensions/DOM.js"></script>
    <script type="text/javascript" src="static/js/extensions/MouseEvent.js"></script>
    <script type="text/javascript" src="static/js/extensions/Number.js"></script>
    <script type="text/javascript" src="static/js/extensions/Object.js"></script>
    <script type="text/javascript" src="static/js/extensions/String.js"></script>

    <script type="text/javascript" src="static/js/Logging/Log.js"></script>

    <script type="text/javascript" src="static/js/Tree/Tree.js"></script>
    <script type="text/javascript" src="static/js/Tree/TreeVis.js"></script>

    <script type="text/javascript" src="static/js/Cache/DummyCache.js"></script>
    <script type="text/javascript" src="static/js/Cache/Cache.js"></script>

    <script type="text/javascript" src="static/js/OFraMP/Atom.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/AtomList.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/Bond.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/BondList.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/Molecule.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/MoleculeViewer.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/OFraMP.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/SelectionArea.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/settings.js"></script>

    <script type="text/javascript" src="static/js/OFraMP/Behavior.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/behaviors/NaiveBehavior.js"></script>
    <script type="text/javascript" src="static/js/OFraMP/behaviors/SmartBehavior.js"></script>
    <script>
      window.onload = function() {
        log("system.load.page", "OFraMP loaded");
        var OAPoC_URL = document.URL.match(/vps955\.directvps\.nl/) ? "http://vps955.directvps.nl/OAPoC/" : "http://127.0.0.1:8000/";
        var OMFraF_URL = document.URL.match(/vps955\.directvps\.nl/) ? "http://vps955.directvps.nl/OMFraF/" : "http://127.0.0.1:8001/";

        var oframp = new OFraMP(NaiveBehavior, "oframp", {
          oapoc : {
            url : OAPoC_URL
          },
          omfraf: {
            url: OMFraF_URL
          }
        });

        window.onresize = function() {
          oframp.setMVSize(document.documentElement.clientWidth, document.documentElement.clientHeight);
        };

        // ONLY for debug purposes, TODO : remove
        doframp = oframp;

        var zi = document.getElementById("zoomin");
        zi.onclick = function() {
          log("user.click.zoom_in", "Zoom in clicked");
          oframp.zoom(1.1);
        };
        var zo = document.getElementById("zoomout");
        zo.onclick = function() {
          log("user.click.zoom_out", "Zoom out clicked");
          oframp.zoom(.9);
        };
        var zp = document.getElementById("zoom");
        zp.onclick = function(e, x, y, z) {
          switch(zp.value) {
            case 'min':
              log("user.click.zoom", "Minimize clicked");
              oframp.minimize();
              break;

            case 'max':
              log("user.click.zoom", "Maximize clicked");
              oframp.maximize();
              break;

            case 'avg':
              log("user.click.zoom", "Idealize clicked");
              oframp.idealize();
              break;

            case 'fit':
              log("user.click.zoom", "Best fit clicked");
              oframp.bestFit();
              break;
          }
          zp.value = 'pre';
        };

        var rp = document.getElementById("reset");
        rp.onclick = function() {
          log("user.click.reset", "Reset positions clicked");
          oframp.resetPositions();
        };

        var dl = document.getElementById("download");
        dl.onclick = function() {
          log("user.click.download", "Download as image clicked");
          var data = oframp.getMVDataURI('image/png');
          this.href = data.replace(/^data:image\/[^;]/, 'data:application/octet-stream');
          var date = $ext.date.format(new Date(), "%Y%m%d%H%M%S");
          this.download = "OFraMP-" + date + ".png";
        };

        var nm = document.getElementById("new");
        $ext.dom.onMouseClick(nm, function() {
          log("user.click.new_molecule", "New molecule clicked");
          newMolecule();
        }, $ext.mouse.LEFT);
        function newMolecule() {
          oframp.showInsertMoleculePopup();
        }

        var of = document.getElementById("open");
        $ext.dom.onMouseClick(of, function() {
          log("user.click.open", "Open clicked");
          openFile();
        }, $ext.mouse.LEFT);
        function openFile() {
          oframp.showInsertMoleculePopup();
          var lb = document.getElementById("input_oss");
          lb.click();
        }

        var sv = document.getElementById("save");
        $ext.dom.onMouseClick(sv, function() {
          log("user.click.save", "Save clicked");
          saveMolecule();
        }, $ext.mouse.LEFT);
        function saveMolecule() {
          var data = oframp.getDataURI();
          sv.href = data;
          var date = $ext.date.format(new Date(), "%Y%m%d%H%M%S");
          sv.type = "application/json";
          sv.download = "OFraMP-" + date + ".oss";
        }

        var ub = document.getElementById("undo");
        $ext.dom.onMouseClick(ub, function() {
          log("user.click.undo", "Undo clicked");
          undo();
        });

        var rb = document.getElementById("redo");
        $ext.dom.onMouseClick(rb, function() {
          log("user.click.redo", "Redo clicked");
          redo();
        });

        var op = document.getElementById("opti");
        if ($ext.onBrokenIE()) {
          op.remove();
        } else {
          $ext.dom.onMouseClick(op, function() {
            log("user.click.settings", "Settings clicked");
            oframp.settingsUI.toggle();
          }, $ext.mouse.LEFT);
        }

        function undo() {
          if(!oframp.checkpoints) {
            return;
          }

          if(oframp.activeCheckpoint > 0) {
            oframp.previousCheckpoint();
          }
        }

        function redo() {
          if(!oframp.checkpoints) {
            return;
          }

          if(oframp.activeCheckpoint < oframp.checkpoints.length - 1) {
            oframp.nextCheckpoint();
          }
        }

        var controlsInitialized = false;
        var controls = document.getElementById("controls");
        var extraControls = document.getElementById("extra_controls");
        var toggle = document.getElementById("extra_controls_toggle");
        function initControls() {
          controls.style.visibility = "visible";

          $ext.dom.onMouseClick(toggle, function() {
            if(extraControls.style.visibility === "visible") {
              controls.style.bottom = "12px";
              extraControls.style.height = "0px";
              extraControls.style.padding = "0px";
              extraControls.style.visibility = "hidden";
              toggle.style.backgroundImage = "url('static/img/open.png')";
              log("user.click.hide_extra_controls", "Hide extra controls clicked");
            } else {
              controls.style.bottom = "34px";
              extraControls.style.visibility = "visible";
              extraControls.style.height = "34px";
              extraControls.style.padding = "2px";
              toggle.style.backgroundImage = "url('static/img/close.png')";
              log("user.click.show_extra_controls", "Show extra controls clicked");
            }
          }, $ext.mouse.LEFT);

          $ext.dom.addEventListener(window, 'keydown', function(evt) {
            if(!evt.altKey) {
              return;
            }

            var keyCode = evt.keyCode || evt.charCode;
            if(keyCode > 26) {
              keyCode -= 64;
            }
            if(keyCode === 26) {
              if(evt.shiftKey) {
                log("user.press.redo", "Redo (Alt+Shift+Z) pressed");
                redo();
              } else {
                log("user.press.undo", "Undo (Alt+Z) pressed");
                undo();
              }
            } else if(keyCode === 25) {
              log("user.press.redo", "Redo (Alt+Y) pressed");
              redo();
            } else if(keyCode === 14) {
              log("user.press.new", "New (Alt+N) pressed");
              newMolecule();
            } else if(keyCode === 15) {
              log("user.press.open", "Open (Alt+O) pressed");
              openFile();
            } else if(keyCode === 19) {
              log("user.press.save", "Save (Alt+S) pressed");
              saveMolecule();
              sv.click();
            }
          });

          controlsInitialized = true;
        }


        $ext.dom.addEventListener(oframp.container, 'moleculeentered', function() {
          if (controlsInitialized) {
            controls.style.display = "none";
            extraControls.style.display = "none";
          }
        });

        $ext.dom.addEventListener(oframp.container, 'moleculedisplayed', function() {
          if (!controlsInitialized) {
            initControls();
          } else {
            controls.style.display = "block";
            extraControls.style.display = "block";
          }
        });

        $ext.dom.addEventListener(oframp.container, 'historychanged', function() {
          if(oframp.activeCheckpoint === 0) {
            ub.disabled = "disabled";
          } else {
            ub.disabled = "";
          }

          if(oframp.activeCheckpoint === oframp.checkpoints.length - 1) {
            rb.disabled = "disabled";
          } else {
            rb.disabled = "";
          }
        });
      };
    </script>
  </head>

  <body>
    <div id="logo">
      <span id="logo_o">O</span><span id="logo_fra">Fra</span><span id="logo_m">M</span><span id="logo_p">P</span>
    </div>

    <div id="controls">
      <div class="bgroup">
        <button id="new" class="border_box" title="Submit another molecule (Alt+N)">
          New molecule
        </button>
        <button id="open" class="border_box" title="Open a saved molecule (Alt+O)">
          Open
        </button>
        <a id="save" class="border_box" href="#" title="Save the current state (Alt+S)">
          Save
        </a>
      </div>

      <div class="bgroup">
        <button id="undo" class="border_box" title="Undo last action (Alt+Z)">
          Undo
        </button>
        <button id="redo" class="border_box" title="Redo last action (Alt+Y / Alt+Shift+Z)">
          Redo
        </button>
      </div>

      <div class="bgroup" id="fragment_controls">
        <button id="find_fragments" class="border_box" title="Find matching fragments">
          Find fragments
        </button>
      </div>

      <div class="bgroup">
        <button id="extra_controls_toggle" class="border_box" title="Show/Hide advanced controls">
          &nbsp;
        </button>
      </div>
    </div>

    <div id="extra_controls">
      <div class="bgroup">
        <button id="zoomin" class="border_box" title="Zoom in">
          Zoom +
        </button>
        <button id="zoomout" class="border_box" title="Zoom out">
          Zoom -
        </button>
        <select id="zoom" class="border_box" title="Zoom to a predefined level">
          <option value="pre" disabled="disabled" selected="selected">Predefined</option>
          <option value="min">Minimal</option>
          <option value="avg">Ideal</option>
          <option value="max">Maximal</option>
          <option value="fit">Best fit</option>
        </select>
      </div>

      <div class="bgroup">
        <button id="reset" class="border_box" title="Reset the atom positions">
          Reset positions
        </button>
      </div>

      <div class="bgroup">
        <a id="download" class="border_box" href="" title="Download the molecule as an image">
          Download as image
        </a>
      </div>

      <div class="bgroup">
        <button id="opti" class="border_box" title="Settings">
          Settings
        </button>
      </div>
    </div>

    <div id="copyright">
      &copy; 2013-2014 jimivdw | CWI
    </div>

    <div id="oframp"></div>
  </body>
</html>
